---
name: Fix theme persistence and Avito modal navigation
overview: Исправить сохранение темы при обновлении страницы и добавить навигацию в модальном окне Avito (кнопка "Назад" и возможность закрыть модалку).
todos:
  - id: fix-theme-persistence
    content: "Исправить сохранение темы: добавить загрузку из localStorage, улучшить логику загрузки при инициализации"
    status: completed
  - id: add-modal-navigation
    content: "Добавить навигацию в модальном окне Avito: кнопки Назад и Отмена на всех шагах"
    status: completed
---

# Исправление сохранения темы и навигации в модальном окне Avito

## Проблемы

1. **Тема не сохраняется при обновлении страницы** - тема слетает обратно на темную, хотя должна загружаться из профиля пользователя
2. **Нет навигации в модальном окне Avito** - когда аккаунты не найдены, нет кнопки "Назад" или возможности закрыть модалку

## Решения

### 1. Исправление сохранения темы

**Файл:** [`src/contexts/ThemeContext.tsx`](src/contexts/ThemeContext.tsx)

**Проблема:** `loadTheme` вызывается только когда `user` меняется, но при первой загрузке страницы `user` может быть `null` сначала, и тема не загружается.

**Изменения:**

- Добавить загрузку темы из localStorage как fallback при инициализации
- Улучшить логику загрузки темы: загружать сразу при монтировании компонента, даже если `user` еще не загружен
- Добавить проверку: если `user` загружается, дождаться его и загрузить тему из БД
- Применить тему к `document.documentElement` сразу при загрузке из localStorage

**Логика:**

1. При монтировании: загрузить тему из localStorage (если есть) и применить
2. Когда `user` загрузится: загрузить тему из БД и обновить (если отличается от localStorage)
3. При сохранении: сохранить в БД и в localStorage

### 2. Добавление навигации в модальном окне Avito

**Файл:** [`src/components/AvitoConnectModal.tsx`](src/components/AvitoConnectModal.tsx)

**Проблема:** На шаге 1 (выбор аккаунта) когда аккаунты не найдены, нет кнопки "Назад" или возможности закрыть модалку. `footer={null}` убирает все кнопки.

**Изменения:**

- Добавить кастомный `footer` с кнопками навигации
- На шаге 1 (выбор аккаунта): добавить кнопку "Назад" (если `currentStep > 0`) и кнопку "Отмена"
- На других шагах: добавить кнопку "Назад" (если `currentStep > 0`) и кнопку "Отмена"
- Убедиться, что кнопка закрытия (X) всегда видна в заголовке модалки

**Структура footer:**

- Если `currentStep > 0`: кнопка "Назад" слева
- Кнопка "Отмена" справа (или "Закрыть")
- На последнем шаге: кнопка "Завершить подключение" вместо "Назад"

## Порядок выполнения

1. Исправить сохранение темы в ThemeContext (приоритет - пользователь видит проблему сразу)
2. Добавить навигацию в модальном окне Avito

## Тестирование

- Проверить сохранение темы: выбрать светлую тему, обновить страницу - должна остаться светлой
- Проверить загрузку темы: зайти в аккаунт с сохраненной темой - должна загрузиться правильная тема
- Проверить модальное окно: открыть, на шаге 1 (аккаунты не найдены) - должна быть кнопка "Назад" и возможность закрыть
- Проверить навигацию: перейти на шаг 2, нажать "Назад" - должен вернуться на шаг 1